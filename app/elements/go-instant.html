<!--
  Go Instant Polymer Element.

  Ex:  <go-connect account="ACCOUNT_NUMBER" app="APP_NAME" room="ROOM_NAME" key="KEY_NAME"></go-connect>

  <script>
     var goInstant =  document.querySelector('go-instant');

     goInstant.findAll(function(res) {
      console.log(res);
     });
  </script>
-->

<polymer-element name="go-instant" attributes="account app room key">
  <template></template>

  <script>
    (function() {
      /*
       * Start Private functions
       */
      function _getConnection(account, app, room) {
        var url = 'https://goinstant.net/' + account + '/' + app;

        var opts = {};

        /*
         * If room is defined connect to it
         * otherwise connect to lobby
         */
        if(room) {
          opts.room = room;
        }

        return goinstant.connect(url, opts);
      }

      function _getKey(con, keyName) {
        return con.rooms[0].key(keyName);
      }

      /*
       * Return public polymer object
       */
      return Polymer('go-instant', {
        account: null,
        app: null,
        room: null,
        key: null,

        /*
         * Get all data from specified key
         * Requires connection promise result
         * returns object
         */
        findAll: function(callback) {
          var keyName = this.key;

          _getConnection(this.account, this.app, this.room)
            .then(function(connection) {
              if(!connection) {
                throw 'ERR: a connection is required!';
              }

              var key = _getKey(connection, keyName);

              key.get().then(function(res) {
                if(callback) {
                  callback(res);
                }

                return res;
              });
            });
        },

        /*
         * Get queried data from specified
         * Requires connection promise result
         * returns array
         */
        find: function(params, callback) {
          var keyName = this.key;

          _getConnection(this.account, this.app, this.room)
            .then(function(connection) {
              var key = _getKey(connection, keyName);

              var query = key.query(params);

              query.execute(function (err, res) {
                if (err) {
                  throw err;
                }

                if (callback) {
                  callback(res);
                }

                return res;
              });
            });
        },

        /*
         * Add new data to specified key
         * Requires connection promise results, and value to be saved
         */
        add: function(val, callback) {
          var keyName = this.key;

          _getConnection(this.account, this.app, this.room)
            .then(function(connection) {
              var key = _getKey(connection, keyName);

              key.add(val, function (err, newValue) {
                if (err) {
                  throw err;
                }

                if (callback) {
                  callback(newValue);
                }

                return newValue;
              });
            });
        },

        /*
         * Delete specified data from key
         */
        remove: function(id, callback) {
          var keyName = this.key;

          _getConnection(this.account, this.app, this.room)
            .then(function(connection) {
              var parentKey = _getKey(connection, keyName);

              parentKey.key(id).remove({ lastValue: true }, function(err, value, context) {
                if(err) {
                  throw err;
                }

                if(callback) {
                  callback(value, context);
                }
              });
            });
        }
      });
    })();
  </script>
</polymer-element>